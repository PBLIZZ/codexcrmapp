# CodexCRM: Idealized Setup Guide

This guide outlines the recommended steps to set up the CodexCRM project from scratch, reflecting the final working configuration and incorporating lessons learned.

**Phase 0: Prerequisites**

1.  **Install Tools:** Ensure Node.js (v18+), pnpm (v9+), and Supabase CLI are installed.
    ```bash
    node -v
    pnpm -v  # If missing: npm install -g pnpm
    supabase -v # If missing: npm install -g supabase
    supabase login # Authenticate with Supabase
    ```

**Phase 1: Project Initialization & Monorepo Setup**

1.  **Create Project Directory:**
    ```bash
    mkdir codexcrmapp
    cd codexcrmapp
    git init # Initialize Git repository
    ```

2.  **Initialize Monorepo Structure:**
    ```bash
    # Create core directories
    mkdir apps packages

    # Create standard package directories
    mkdir -p packages/server packages/db packages/jobs packages/ui

    # Create Next.js app within apps/web
    # Note: Adjust create-next-app options as needed (e.g., --ts for TypeScript)
    pnpm create next-app apps/web --ts --tailwind --eslint --app --src-dir --import-alias "@/*"

    # Create supabase directory (if using CLI locally)
    mkdir supabase
    ```

3.  **Define pnpm Workspace:** Create `pnpm-workspace.yaml` in the root:
    ```yaml
    # pnpm-workspace.yaml
    packages:
      - 'apps/*'
      - 'packages/*'
    ```

4.  **Initialize Core Packages:** Create `package.json` in each package:
    ```bash
    # From root directory
    (cd packages/server && pnpm init -y && jq '.name = "@codexcrm/server"' package.json > temp.$$.json && mv temp.$$.json package.json)
    (cd packages/db && pnpm init -y && jq '.name = "@codexcrm/db"' package.json > temp.$$.json && mv temp.$$.json package.json)
    (cd packages/jobs && pnpm init -y && jq '.name = "@codexcrm/jobs"' package.json > temp.$$.json && mv temp.$$.json package.json)
    (cd packages/ui && pnpm init -y && jq '.name = "@codexcrm/ui"' package.json > temp.$$.json && mv temp.$$.json package.json)
    # Note: jq is used here to set the package name. Adjust 'main', 'types' etc. later.
    ```

5.  **Configure Root `.gitignore`:** Create `codexcrmapp/.gitignore`:
    ```gitignore
    # Environment variables
    .env
    .env.*
    !.env.example

    # Dependencies
    node_modules/

    # Build outputs
    dist/
    .next/
    out/

    # IDE / OS files
    .DS_Store
    *.code-workspace
    .vscode/
    ```

6.  **Configure TypeScript Path Aliases (Root):** Create `codexcrmapp/tsconfig.json`:
    ```json
    // codexcrmapp/tsconfig.json
    {
      "compilerOptions": {
        "target": "es2017",
        "lib": ["dom", "dom.iterable", "esnext"],
        "allowJs": true,
        "skipLibCheck": true,
        "strict": true,
        "forceConsistentCasingInFileNames": true,
        "noEmit": true,
        "esModuleInterop": true,
        "module": "esnext",
        "moduleResolution": "bundler",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "jsx": "preserve",
        "incremental": true,
        "baseUrl": ".",
        "paths": {
          "@codexcrm/server/*": ["packages/server/src/*"],
          "@codexcrm/db/*": ["packages/db/src/*"],
          "@codexcrm/jobs/*": ["packages/jobs/*"],
          "@codexcrm/ui/*": ["packages/ui/src/*"],
          "@codexcrm/web/*": ["apps/web/*"]
        }
      },
      "include": [],
      "exclude": ["node_modules", "dist"]
    }
    ```

7.  **Configure TypeScript Path Aliases (Web App):** Modify `apps/web/tsconfig.json`:
    ```json
    // apps/web/tsconfig.json
    {
      "extends": "../../tsconfig.json", // Extend root config
      "compilerOptions": {
        // Keep app-specific settings generated by create-next-app
        // Ensure "baseUrl": "." and "paths": { "@/*": ["./src/*"] } are present
        "baseUrl": ".",
        "paths": {
          "@/*": ["./src/*"]
        },
        "lib": ["dom", "dom.iterable", "esnext"],
        "allowJs": true,
        "skipLibCheck": true,
        "strict": true, // Ensure strict mode is enabled
        "noEmit": true,
        "esModuleInterop": true,
        "module": "esnext",
        "moduleResolution": "bundler",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "jsx": "preserve",
        "incremental": true,
        "plugins": [
          {
            "name": "next"
          }
        ]
      },
      "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
      "exclude": ["node_modules"]
    }
    ```

8.  **Install Initial Dependencies:** Run from the root:
    ```bash
    pnpm install
    ```

**Phase 2: Supabase Integration**

1.  **Link Supabase Project:** Run from the root (if using CLI locally):
    ```bash
    supabase link --project-ref YOUR_PROJECT_REF # Find in Supabase dashboard URL
    supabase db pull # Pull initial schema if exists
    ```

2.  **Generate Types:** Generate TypeScript types from your Supabase schema:
    ```bash
    # Adjust output path as needed, e.g., packages/db/src/database.types.ts
    supabase gen types typescript --project-id YOUR_PROJECT_REF --schema public > packages/db/src/database.types.ts
    # Ensure packages/db/src exists: mkdir -p packages/db/src
    ```

3.  **Configure Environment Variables:** Create `apps/web/.env.local`:
    ```dotenv
    # apps/web/.env.local
    NEXT_PUBLIC_SUPABASE_URL=YOUR_SUPABASE_URL
    NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_SUPABASE_ANON_KEY
    SUPABASE_SERVICE_ROLE_KEY=YOUR_SUPABASE_SERVICE_ROLE_KEY # Keep this secret!
    # Optional: SUPABASE_JWT_SECRET=YOUR_JWT_SECRET
    ```

**Phase 3: tRPC & Data Fetching Setup**

1.  **Install Core Dependencies:** Run from the root:
    ```bash
    # Server-side tRPC & Supabase Admin
    pnpm --filter @codexcrm/server add @trpc/server zod @supabase/supabase-js

    # Client-side tRPC, React Query, Supabase SSR
    pnpm --filter @codexcrm/web add @trpc/client @trpc/server @trpc/react-query @tanstack/react-query @supabase/ssr @supabase/auth-helpers-nextjs zod
    # Ensure compatible versions (Example working set: tRPC v10.43.6, TanStack Query v4.36.1)

    # Add server as a workspace dependency for the web app
    pnpm --filter @codexcrm/web add @codexcrm/server@workspace:*
    ```

2.  **Setup tRPC Core (`packages/server`):**
    *   Create `packages/server/src/trpc.ts` (initTRPC)
    *   Create `packages/server/src/context.ts` (createContext using Supabase SSR helpers)
    *   Create `packages/server/src/middleware.ts` (isAuthed middleware)
    *   Create `packages/server/src/supabaseAdmin.ts` (Supabase admin client using SERVICE_ROLE_KEY)
    *   Create `packages/server/src/root.ts` (appRouter merging all sub-routers)

3.  **Implement First tRPC Router (`packages/server`):**
    *   Create `packages/server/src/routers/clients.ts` (define `list`, `create` etc. using `protectedProcedure`)
    *   Merge this router into `appRouter` in `root.ts`. **Important:** Use a name like `clients` (not `client`) to avoid conflicts.

4.  **Setup tRPC API Route (`apps/web`):**
    *   Create `apps/web/app/api/trpc/[trpc]/route.ts` (fetchRequestHandler using `appRouter` and `createContext`).

5.  **Setup tRPC Client & Providers (`apps/web`):**
    *   Create `apps/web/src/lib/trpc.ts` (create tRPC client, ensure correct import path `@codexcrm/server/src/root` for `AppRouter`).
    *   Create `apps/web/app/providers.tsx` (QueryClientProvider, trpc.Provider wrapping children).
    *   Use `Providers` in `apps/web/app/layout.tsx`.

**Phase 4: Basic UI & Authentication**

1.  **Install Shadcn UI:** Follow Shadcn UI setup for Next.js (`pnpm dlx shadcn-ui@latest init` in `apps/web`).
2.  **Implement Auth UI:** Create sign-in, sign-up pages/components in `apps/web/app` using Supabase client functions (`signInWithPassword`, `signUp`, etc.) and Shadcn components.
3.  **Implement Client Page:**
    *   Create `apps/web/app/clients/page.tsx` (Server Component, potentially checking auth).
    *   Create `apps/web/app/clients/ClientsContent.tsx` (Client Component `'use client'`).
    *   Use `api.clients.list.useQuery()` hook in `ClientsContent.tsx` to fetch data.
    *   Display data using Shadcn Table or similar components.
    *   Handle loading and error states from `useQuery`.

**Phase 5: Deployment (Vercel)**

1.  **Push to Git:** Commit all changes and push to GitHub/GitLab.
2.  **Import Project to Vercel:** Connect your Git repository.
3.  **Configure Vercel Settings:**
    *   Framework Preset: `Next.js`.
    *   Root Directory: `apps/web`.
    *   Build Command: `pnpm build` (usually auto-detected).
    *   Install Command: `pnpm install` (usually auto-detected).
    *   Environment Variables: Add `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`.
4.  **Deploy:** Trigger a deployment.

This guide provides a high-level overview of the correct setup sequence based on the working state of the project. Refer to the actual code files for detailed implementation specifics.